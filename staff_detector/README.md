# Группа 2: Детектор нотных строк (Staff Detection)

## Задача
Находить нотные строки на изображении — группы из 5 горизонтальных линий. Выделять каждую строку как отдельный фрагмент.

## Команда
2 человека

## Что нужно сделать

### 1. Детекция горизонтальных линий
- Найти все горизонтальные линии на изображении
- Использовать морфологические операции OpenCV
- Фильтровать линии по длине и толщине
- Удалить шум и артефакты

### 2. Группировка линий в станы
- Сгруппировать близкие линии в нотные станы
- Обычно стан состоит из 5 линий
- Учесть возможные отклонения (4-6 линий)
- Определить границы каждого стана

### 3. Извлечение областей станов
- Вырезать каждый стан как отдельное изображение
- Добавить отступы сверху и снизу
- Сохранить координаты в исходном изображении
- Создать маску для каждого стана

### 4. Визуализация результатов
- Показать найденные линии на изображении
- Выделить границы станов
- Создать отладочные изображения

## Технологии
- **OpenCV** - основная библиотека для обработки изображений
- **numpy** - для работы с массивами
- **PIL** - для загрузки и сохранения изображений

## Структура файлов
```
staff_detector/
├── split_staffs.py    # Основной модуль детекции
└── README.md          # Этот файл
```

## Как запустить

### Основная функция:
```python
from split_staffs import extract_staff_regions

# Извлечение станов из изображения
staff_regions = extract_staff_regions(
    image_path="path/to/sheet_music.png",
    output_dir="extracted_staffs"
)

print(f"Найдено {len(staff_regions)} нотных станов")
```

### Визуализация:
```python
from split_staffs import visualize_staff_detection

# Создание изображения с выделенными линиями
visualize_staff_detection(
    image_path="path/to/sheet_music.png",
    output_path="detection_result.png"
)
```

## Входные данные
- Изображения нотных листов (PNG, JPG, TIFF)
- Разрешение: любое
- Формат: цветное или черно-белое

## Выходные данные
- Список областей станов с координатами
- Отдельные изображения каждого стана
- Метаданные: позиция, размер, количество линий

## Цели
1. **Точность детекции:** > 95% станов найдено правильно
2. **Производительность:** < 2 секунды на изображение A4
3. **Устойчивость:** работа с разными стилями нот
4. **Качество вырезки:** четкие границы станов

## Критерии готовности
- [ ] Функция `extract_staff_regions()` работает корректно
- [ ] Найдено > 90% станов на тестовых изображениях
- [ ] Каждый стан вырезан с отступами
- [ ] Визуализация показывает правильные результаты
- [ ] Код обрабатывает ошибки (нет станов, плохое качество)
- [ ] Документация функций написана

## Связь с другими группами
- **Вход:** изображения нотных листов от группы 6 (interface) или группы 7 (pipeline)
- **Выход:** отдельные изображения станов для группы 3 (symbol_detector)
- **Тестирование:** используйте изображения из `recognize_old/`

## Алгоритм работы
1. **Предобработка:**
   - Конвертация в grayscale
   - Бинаризация (Otsu или адаптивная)
   - Удаление шума

2. **Детекция линий:**
   - Морфологическая операция "открытие" с горизонтальным ядром
   - Поиск контуров
   - Фильтрация по размеру и форме

3. **Группировка:**
   - Сортировка линий по Y-координате
   - Поиск групп близких линий
   - Определение границ станов

4. **Извлечение:**
   - Вычисление границ с отступами
   - Вырезание областей
   - Сохранение метаданных

## Тестирование
1. **Простые случаи:** чистые нотные листы
2. **Сложные случаи:** повернутые, с шумом, разного размера
3. **Граничные случаи:** один стан, много станов, нет станов

## Советы
1. Начните с простых изображений
2. Используйте разные методы бинаризации
3. Экспериментируйте с параметрами морфологии
4. Добавьте логирование для отладки
5. Тестируйте на разных типах нот

## Если застряли
1. Проверьте качество входного изображения
2. Попробуйте разные пороги бинаризации
3. Уменьшите размер изображения для отладки
4. Посмотрите примеры в OpenCV документации
5. Обратитесь к Адлану за помощью

## Полезные ссылки
- [OpenCV Morphological Operations](https://docs.opencv.org/4.x/d9/d61/tutorial_py_morphological_ops.html)
- [Contour Detection](https://docs.opencv.org/4.x/d4/d73/tutorial_py_contours_begin.html)
- [Image Processing Techniques](https://docs.opencv.org/4.x/d6/d00/tutorial_py_root.html) 