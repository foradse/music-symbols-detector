# Группа 4: Экспорт в MusicXML

## Задача
Взять распознанные символы и собрать из них упрощённую мелодию. Записать это в музыкальный XML-файл, который можно открыть в MuseScore.

## Команда
2 человека

## Что нужно сделать

### 1. Парсинг результатов распознавания
- Получить список символов с их классами и позициями
- Отсортировать символы по позиции (слева направо)
- Сгруппировать символы по тактам
- Определить последовательность нот

### 2. Создание структуры MusicXML
- Создать базовую структуру XML файла
- Добавить метаданные (название, автор, размер)
- Создать партии (parts) и такты (measures)
- Настроить атрибуты (ключ, размер, тональность)

### 3. Конвертация символов в ноты
- Преобразовать классы символов в музыкальные элементы
- Определить высоту нот по позиции на стане
- Установить длительности нот
- Добавить знаки альтерации

### 4. Генерация XML файла
- Создать валидный MusicXML документ
- Добавить все музыкальные элементы
- Сохранить файл с правильным форматированием
- Проверить совместимость с MuseScore

## Технологии
- **xml.etree.ElementTree** - для создания XML
- **xml.dom.minidom** - для форматирования XML
- **numpy** - для работы с координатами
- **PIL** - для анализа изображений (опционально)

## Структура файлов
```
xml_exporter/
├── export.py          # Основной модуль экспорта
└── README.md          # Этот файл
```

## Как запустить

### Основная функция:
```python
from export import MusicXMLExporter

# Создание экспортера
exporter = MusicXMLExporter()

# Экспорт результатов распознавания
exporter.export_from_recognition_results(
    results=recognition_results,
    output_file="output.musicxml"
)
```

### Создание простого примера:
```python
from export import create_sample_musicxml

# Создание примера MusicXML файла
create_sample_musicxml()
```

### Ручное создание элементов:
```python
from export import MusicXMLExporter

exporter = MusicXMLExporter()
exporter.create_musicxml_structure("My Music")

# Добавление такта
exporter.add_measure(1)
exporter.add_attributes()

# Добавление ключа
exporter.add_clef("G", 2)

# Добавление нот
exporter.add_note("C", 4, 1, "quarter")
exporter.add_note("D", 4, 1, "quarter")

# Сохранение
exporter.export_to_file("my_music.xml")
```

## Входные данные
- Список распознанных символов от группы 1 (classifier)
- Координаты символов от группы 3 (symbol_detector)
- Метаданные о нотном стане от группы 2 (staff_detector)

## Выходные данные
- MusicXML файл (.musicxml)
- Совместимый с MuseScore, Finale, Sibelius
- Валидный XML документ

## Цели
1. **Совместимость:** файл открывается в MuseScore
2. **Корректность:** валидный MusicXML формат
3. **Читаемость:** правильно отформатированный XML
4. **Функциональность:** основные музыкальные элементы

## Критерии готовности
- [ ] Функция `export_from_recognition_results()` работает корректно
- [ ] Созданный XML файл открывается в MuseScore
- [ ] Поддерживаются основные музыкальные элементы
- [ ] XML документ валиден
- [ ] Код обрабатывает ошибки (пустые результаты, неверные данные)
- [ ] Документация функций написана

## Связь с другими группами
- **Вход:** результаты распознавания от группы 1 (classifier)
- **Вход:** координаты символов от группы 3 (symbol_detector)
- **Выход:** MusicXML файл для группы 6 (interface) и группы 7 (pipeline)
- **Тестирование:** используйте результаты из `recognize_old/`

## Алгоритм работы
1. **Парсинг входных данных:**
   - Получение списка символов с классами
   - Сортировка по X-координате
   - Группировка по тактам

2. **Создание XML структуры:**
   - Инициализация корневого элемента
   - Добавление метаданных
   - Создание партий

3. **Конвертация символов:**
   - Маппинг классов на музыкальные элементы
   - Определение высоты нот
   - Установка длительностей

4. **Генерация файла:**
   - Создание XML элементов
   - Форматирование документа
   - Сохранение в файл

## Тестирование
1. **Простые случаи:** одна нота, простые мелодии
2. **Сложные случаи:** аккорды, паузы, знаки альтерации
3. **Граничные случаи:** пустые результаты, один символ

## Советы
1. Начните с простых мелодий
2. Изучите MusicXML спецификацию
3. Тестируйте в MuseScore
4. Добавьте логирование для отладки
5. Используйте валидаторы XML

## Если застряли
1. Проверьте формат входных данных
2. Посмотрите примеры MusicXML файлов
3. Используйте валидатор XML
4. Проверьте документацию MusicXML
5. Обратитесь к Адлану за помощью

## Полезные ссылки
- [MusicXML Specification](https://www.w3.org/2021/06/musicxml40/)
- [MusicXML Tutorial](https://www.musicxml.com/tutorial/)
- [MuseScore Documentation](https://musescore.org/en/handbook)

## Поддерживаемые элементы
- **Ключи:** G, F, C ключи
- **Ноты:** целые, половинные, четвертные, восьмые
- **Паузы:** соответствующие длительности
- **Знаки альтерации:** диез, бемоль, бекар
- **Размеры:** 2/4, 3/4, 4/4, 6/8
- **Тональности:** основные мажорные и минорные

## Пример структуры MusicXML
```xml
<?xml version="1.0" encoding="UTF-8"?>
<score-partwise version="4.0">
  <work>
    <work-title>Sample Music</work-title>
  </work>
  <part-list>
    <score-part id="P1">
      <part-name>Music</part-name>
    </score-part>
  </part-list>
  <part id="P1">
    <measure number="1">
      <attributes>
        <divisions>1</divisions>
        <key>
          <fifths>0</fifths>
        </key>
        <time>
          <beats>4</beats>
          <beat-type>4</beat-type>
        </time>
      </attributes>
      <clef>
        <sign>G</sign>
        <line>2</line>
      </clef>
      <note>
        <pitch>
          <step>C</step>
          <octave>4</octave>
        </pitch>
        <duration>1</duration>
        <type>quarter</type>
      </note>
    </measure>
  </part>
</score-partwise>
``` 